<!DOCTYPE html>
<html lang="ko">

<head>

    <meta charset="UTF-8"/>


    <meta title="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- Bootstrap ì„ í¬í•¨í•©ë‹ˆë‹¤. -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">

    <!-- jQuery ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- CSS library ì¸ Bulma ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css"/>

    <!-- í…ìŠ¤íŠ¸í˜•íƒœë¡œ ë˜ì–´ìˆëŠ” icon ì„ ì“¸ ìˆ˜ ìˆë„ë¡ Font awesome ì„ í¬í•¨í•˜ë¹ˆë‹¤. -->
    <script src="https://kit.fontawesome.com/0f470a561d.js" crossorigin="anonymous"></script>

    <title>ë§ˆì´ í˜ì´ë³´ë¦¿ ë¬´ë¹„ | í”„ë¡ íŠ¸-ë°±ì—”ë“œ ì—°ê²° ë§ˆì§€ë§‰ ì˜ˆì œ!</title>


    <!-- ì˜ˆ: <div class="center"> -->
    <style>
        .center {
            text-align: center;
        }

        .sorter-box {
            width: 550px;
        }

        .movie-list {
            width: 550px;
            margin: 20px auto 0 auto;
        }

        .movie-title {
            display: inline-block;
            font-size: 130%;
            font-weight: bold;
        }

        .movie-title:hover {
            text-decoration: underline;
        }

        .card {
            margin-bottom: 15px;
            padding: 12px;

        }

        .icon {
            margin-left: 7px;
        }

        .movie-poster {
            width: 100px;
            margin: 30px;
        }

        .card-body {
            padding: 30px;
        }

        #trash {
            text-align: right;
        }

        #col1 {
            text-align: center;
            padding: 10px 0;
            border-top: 2px solid #E2E2E2;

        }

        #col2 {
            text-align: center;
            padding: 10px 0;
            border-top: 2px solid #E2E2E2;

        }

        .updown {
            border: 1px solid black;
            width: 0.1px;
            height: 10px;
        }
    </style>


    <!-- ì´ HTML ì—ì„œ ì‚¬ìš©í•  JavaScript ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. -->
    <script>
        const Sort = {
            BY_LIKES: "likes",
            BY_VIEWERS: "viewers",
            BY_DATE: "date",
        };

        let sortMode = Sort.BY_LIKES
        let trashMode = false


        $(document).ready(function () {
            // ì˜í™” ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
            showMovie()

            // í˜„ì¬ ì ìš©ë˜ê³  ìˆëŠ” ì •ë ¬ ë°©ì‹ì˜ ë²„íŠ¼ì— ëˆŒë ¤ì ¸ ë³´ì´ëŠ” íš¨ê³¼ë¥¼ ì¤ë‹ˆë‹¤.
            displaySorter()

            // íœ´ì§€í†µ ëª¨ë“œì— ë”°ë¼ ë©”ë‰´ë¥¼ ë‹¤ë¥´ê²Œ ë°”ê¿”ì¤ë‹ˆë‹¤.
            displayTrashMode()
        });

        function showMovie() {
            $('#movie-box').empty()


            if (trashMode == false) {
                $.ajax({
                    type: "GET",
                    url: "/api/list",
                    data: {'sortMode': sortMode},
                    success: function (response) {
                        if (response['result'] != 'success') {
                            alert(sortMode + ' ìˆœìœ¼ë¡œ ì˜í™” ëª©ë¡ ë°›ì•„ì˜¤ê¸° ì‹¤íŒ¨!')
                            return
                        }

                        let movies = response['movies_list']
                        addMovieCards(movies, false)
                    }
                })
            } else if (trashMode == true) {
                $.ajax({
                    type: "GET",
                    url: "/api/list/trash",
                    data: {'sortMode': sortMode},
                    success: function (response) {
                        if (response['result'] != 'success') {
                            alert('íœ´ì§€í†µ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨')
                            return
                        }

                        let movies = response['movies_list']

                        addMovieCards(movies, true)
                    }
                })
            }
        }

        function parseDate(dateString) {
            let [year, month, day] = dateString.split('.').map(Number);
            return new Date(year, month - 1, day);
        }

        function addMovieCards(movies, trashMode) {

            if (sortMode === Sort.BY_LIKES) {
                movies.sort((a, b) => b.likes - a.likes);
            } else if (sortMode === Sort.BY_VIEWERS) {
                movies.sort((a, b) => b.viewers - a.viewers);
            } else if (sortMode === Sort.BY_DATE) {
                movies.sort((a, b) => {

                    let releaseDateA = `${a.open_year}.${a.open_month}.${a.open_day}`;
                    let releaseDateB = `${b.open_year}.${b.open_month}.${b.open_day}`;


                    let dateA = parseDate(releaseDateA);
                    let dateB = parseDate(releaseDateB);


                    return dateB - dateA;
                });
            }

            for (let i = 0; i < movies.length; i++) {
                let movie = movies[i]


                let id = movie['_id']
                let title = movie['title']
                let viewers = movie['viewers']
                let formattedViewers = viewers.toLocaleString();
                let likes = movie['likes']
                let poster_url = movie['poster_url']
                let release_date = movie['open_year'] + "." + movie['open_month'] + "." + movie['open_day']
                let detail_url = movie['info_url']


                let cardContentHtml = `
                        <div class = "col-md-3">
                            <img src="${poster_url}" class="card-img-top movie-poster"/>
                        </div>
                        <div class="col-md-8">
                            <div class="card-body">
                                <a href = "${detail_url}"class="movie-title">${title}</a>
                                <br>
                                <p class="icon"><i class="fas fa-thumbs-up"></i>${likes}</p>
                                <p class="movie-viewers">ëˆ„ì ê´€ê°ìˆ˜ ${formattedViewers}ëª…</p>
                                <p class="movie-date">ê°œë´‰ì¼ ${release_date}</p>
                            </div>
                        </div>
                    `


                let cardFooterHtml = ''
                if (trashMode == false) {
                    cardFooterHtml = `
                    <div class = "col" id = 'col1'>
                            <a href="#" onclick="likeMovie('${title}')">
                            ìœ„ë¡œ!
                            <i class="fas fa-thumbs-up"></i>
                            </a>
                        </div>
                        <div class="vr p-0"></div>
                        <div class = "col" id = 'col2'>
                            <a href="#" onclick="trashMovie('${title}')" class ="has-text-danger">
                            íœ´ì§€í†µìœ¼ë¡œ
                            <i class="fa-solid fa-trash"></i>
                            </a>
                        </div>
                        `
                } else {
                    cardFooterHtml = `
                            <div class = "col" id = 'col1'>
                                <a href="#" onclick="restoreMovie('${title}')">
                                ë³µêµ¬í•˜ê¸°
                                </a>
                            </div>
                            <div class="vr p-0"></div>
                            <div class = "col" id = 'col2'>
                                <a href="#" onclick="deleteMovie('${title}')" class ="has-text-danger">
                                ì˜êµ¬ì‚­ì œ
                                <i class="fa-solid fa-trash"></i>
                                </a>
                            </div>
                        `
                }


                $('#movie-box').append(`
                        <div class="card mb-3 p-0">
                            <div class = "row p-0 m-0">
                            ${cardContentHtml}
                            </div>
                            <div class = "row p-0 m-0">
                            ${cardFooterHtml}
                            </div>
                            
                        </div>
                    `)
            }
        }


        function likeMovie(title) {
            console.log(title)
            $.ajax({
                type: "POST",
                url: "/api/like",
                data: {post_title: title},

                success: function (response) {
                    if (response['result'] == 'success') {
                        // 2. 'ì¢‹ì•„ìš” ì™„ë£Œ!' ì–¼ëŸ¿ì„ ë„ì›ë‹ˆë‹¤.
                        alert('ì¢‹ì•„ìš” ì™„ë£Œ!')
                        // 3. ë³€ê²½ëœ ì •ë³´ë¥¼ ë°˜ì˜í•˜ê¸° ìœ„í•´ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
                        showMovie(false)
                    } else {
                        alert('ì¢‹ì•„ìš” ì‹¤íŒ¨ã… ã… ')
                    }

                }
            });
        }

        function trashMovie(title) {
            $.ajax({
                type: 'POST',
                url: '/api/update/trash',
                data: {post_title: title},
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert('íœ´ì§€í†µìœ¼ë¡œ ë³´ë‚´ì§')
                        showMovie(false)
                    } else
                        alert('íœ´ì§€í†µ ì˜¤ë¥˜')
                }
            })
        }

        function restoreMovie(title) {
            $.ajax({
                type: 'POST',
                url: '/api/update/restore',
                data: {post_title: title},
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert(title + ' ë³µêµ¬ ë¨')
                        showMovie(false)
                    } else
                        alert('ë³µêµ¬ ì˜¤ë¥˜')
                }
            })
        }

        function deleteMovie(title) {
            $.ajax({
                type: 'POST',
                url: '/api/update/delete',
                data: {post_title: title},
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert(title + ' ì‚­ì œ ë¨')
                        showMovie(false)
                    } else
                        alert('ì‚­ì œ ì˜¤ë¥˜')
                }
            })
        }


        function changeSorter(newMode) {
            if (sortMode == newMode) {
                return
            }

            sortMode = newMode
            displaySorter()
            showMovie()
        }


        function displaySorter() {

            document.getElementById("sorter-likes").classList.remove("active");
            document.getElementById("sorter-viewers").classList.remove("active");
            document.getElementById("sorter-date").classList.remove("active");


            switch (sortMode) {
                case Sort.BY_LIKES:
                    document.getElementById("sorter-likes").classList.add("active");
                    break;
                case Sort.BY_VIEWERS:
                    document.getElementById("sorter-viewers").classList.add("active");
                    break;
                case Sort.BY_DATE:
                    document.getElementById("sorter-date").classList.add("active");
                    break;
            }
        }


        let flag = 0

        function displayTrashMode() {
            if (flag == 1) {
                trashMode = true
                showMovie(trashMode)
                $('.watch-trash').html('<i class="fa-solid fa-trash"></i>íœ´ì§€í†µ ë‚˜ê°€ê¸°')
                flag = 0

            } else if (flag == 0) {
                trashMode = false
                showMovie(trashMode)
                $('.watch-trash').html('<i class="fa-solid fa-trash"></i>íœ´ì§€í†µ ë³´ê¸°')
                flag = 1
            }

        }

    </script>
</head>


<body>
<!-- ì œëª© ë¶€ë¶„ -->
<section class="hero is-warning">
    <div class="hero-body">
        <div class="container center">
            <h1 class="title">
                ë§ˆì´ í˜ì´ë³´ë¦¿ ë¬´ë¹„ğŸ˜†
            </h1>
            <h2 class="subtitle">
                ìˆœìœ„ë¥¼ ë§¤ê²¨ë´…ì‹œë‹¤
            </h2>
        </div>
    </div>
</section>

<!-- ì •ë ¬ ì˜µì…˜ ë¶€ë¶„ -->

<div class="mx-auto sorter-box">
    <div class="btn-group m-3 mx-auto w-100">
        <a href="#" class="btn btn-primary" id="sorter-likes" onclick="changeSorter('likes')">ì¢‹ì•„ìš” ìˆœìœ¼ë¡œ ì •ë ¬</a>
        <a href="#" class="btn btn-primary" id="sorter-viewers" onclick="changeSorter('viewers')">ëˆ„ì ê´€ê°ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬</a>
        <a href="#" class="btn btn-primary" id="sorter-date" onclick="changeSorter('date')">ê°œë´‰ì¼ ìˆœìœ¼ë¡œ ì •ë ¬</a>
    </div>
</div>

<!-- "íœ´ì§€í†µ ë³´ê¸°" ë¶€ë¶„ -->
<div class="mx-auto sorter-box" id='trash'>
    <a href="#" onclick="displayTrashMode()" class="watch-trash has-text-primary"></a>
</div>
<br>

<div class="mx-auto sorter-box">
        <span class="d-flex justify-content-end">
            <div id="trash-mode-box">
                <!-- javascript ê°€ ì´ ì‚¬ì´ì— trash mode ì— ë”°ë¼ HTML element ë¥¼ ìƒì„±í•´ì„œ ì‚½ì…í•©ë‹ˆë‹¤. -->
            </div>
        </span>
</div>


<div class="movie-list" id="movie-box">

</div>
</body>

</html>